<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>القرآن الكريم</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#28a745">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="القرآن الكريم">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />

  <style>
    :root{
      --primary-color: #28a745;
      --primary-hover: #218838;
      --secondary-color: #28a745;
      --secondary-hover: #218838;
      --text-dark: #1a2533;
      --text-light: #6c757d;
      --bg-light: #f0f2f5;
      --container-bg: #ffffff;
      --border-color: #dee2e6;
    }
    body{
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: var(--bg-light);
      padding: 10px;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .container{
      max-width: 1200px;
      height: calc(100vh - 20px);
      margin: 0 auto;
      background: var(--container-bg);
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    h1{
      color:var(--text-dark);
      margin:0 0 20px;
      font-size:2rem;
      font-weight:700;
    }
    label{
      display:block;
      text-align:right;
      color:var(--text-dark);
      margin-top:12px;
      margin-bottom:6px;
      font-weight:600;
    }
    select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border-color);
      background:#fcfdff;
      font-size:1rem;
    }
    #loadingMessage{
      margin-top:12px;
      min-height:20px;
      color:var(--text-light);
      font-style:italic;
    }
    #player-wrapper{
      background: var(--container-bg);
      padding-top: 10px;
      padding-bottom: 10px;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.05);
      z-index: 10;
      display:none;
    }
    .info-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .surah-info{
      font-weight:600;
      color:#343a40;
      font-size:1.1rem;
    }
    .download-buttons{
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:10px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:8px;
      font-weight:600;
      color:white;
      text-decoration:none;
      cursor:pointer;
      border:none;
    }
    #downloadLink{ background:var(--secondary-color); }
    #downloadLink:hover{ background:var(--secondary-hover); }

    /* Responsive desktop layout */
    @media (min-width: 900px){
      .container{
        flex-direction: row;
        gap: 24px;
      }
      .controls-column{
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .player-column{
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      #player-wrapper{
        position: static;
        box-shadow: none;
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
      }
    }

    @media (max-width:600px){
      .container{ padding:18px; }
      h1{ font-size:1.6rem; }
    }
    .plyr__progress--played, .plyr__progress__buffer {
      background: var(--primary-color) !important;
    }
    .plyr__control:hover, .plyr__control--pressed {
      color: var(--primary-color) !important;
    }
    .plyr__volume--display .plyr__progress--played {
      background: var(--primary-color) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls-column">
      <h1>القرآن الكريم</h1>

      <label for="languageSelect">اللغة:</label>
      <select id="languageSelect"></select>

      <label for="reciterSelect">القارئ:</label>
      <select id="reciterSelect" disabled></select>

      <label for="moshafSelect">الرواية / المصحف:</label>
      <select id="moshafSelect" disabled></select>

      <label for="surahSelect">السورة:</label>
      <select id="surahSelect" disabled></select>

      <div id="loadingMessage"></div>
    </div>

    <div class="player-column">
      <div id="player-wrapper">
        <div class="info-row">
          <div class="surah-info">
            <span id="playerReciterName"></span> — <span id="playerSurahName"></span>
          </div>
          <div class="download-buttons">
            <a id="downloadLink" class="btn" href="#" download><i class="fas fa-download"></i> تحميل السورة</a>
          </div>
        </div>
        <audio id="audioPlayer" class="plyr" controls crossorigin="anonymous"></audio>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const languageSelect = document.getElementById('languageSelect');
      const reciterSelect = document.getElementById('reciterSelect');
      const moshafSelect = document.getElementById('moshafSelect');
      const surahSelect = document.getElementById('surahSelect');
      const loadingMessage = document.getElementById('loadingMessage');
      const playerWrapper = document.getElementById('player-wrapper');
      const audioPlayer = document.getElementById('audioPlayer');
      const playerSurahName = document.getElementById('playerSurahName');
      const playerReciterName = document.getElementById('playerReciterName');
      const downloadLink = document.getElementById('downloadLink');

      let recitersData = [];
      let surahsData = [];
      let isDownloading = false;
      let savedTime = 0;

      const plyrPlayer = new Plyr(audioPlayer, {
        controls: ['play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'settings'],
        tooltips: { controls: true, seek: true }
      });

      const languages = [
        {code:'ar', name:'العربية'}, {code:'eng', name:'English'}, {code:'fr', name:'Français'},
        {code:'es', name:'Español'}, {code:'de', name:'Deutsch'}, {code:'ur', name:'اردو'},
        {code:'bn', name:'বাংলা'}, {code:'tr', name:'Türkçe'}, {code:'ru', name:'Русский'},
        {code:'id', name:'Bahasa Indonesia'}, {code:'pt', name:'Português'}
      ];
      languageSelect.innerHTML = languages.map(l => `<option value="${l.code}">${l.name}</option>`).join('');
      languageSelect.value = localStorage.getItem('quran_language') || 'ar';

      const showLoading = (msg) => loadingMessage.textContent = msg;
      const hideLoading = () => loadingMessage.textContent = '';
      const fetchJson = async (url) => {
        try {
          showLoading('...جاري تحميل البيانات');
          const res = await fetch(url);
          if (!res.ok) throw new Error();
          const json = await res.json();
          hideLoading();
          return json;
        } catch {
          hideLoading();
          alert('تعذر تحميل البيانات. تحقق من اتصال الانترنت.');
          return null;
        }
      };

      async function populateReciters() {
        reciterSelect.disabled = true;
        moshafSelect.disabled = true;
        surahSelect.disabled = true;
        const data = await fetchJson(`https://www.mp3quran.net/api/v3/reciters?language=${languageSelect.value}`);
        if (data?.reciters) {
          recitersData = data.reciters;
          reciterSelect.innerHTML = `<option value="">-- اختر القارئ --</option>` +
            recitersData.map(r => `<option value="${r.id}" data-moshaf='${JSON.stringify(r.moshaf)}'>${r.name}</option>`).join('');
          reciterSelect.disabled = false;

          const savedReciter = localStorage.getItem('quran_reciter');
          if (savedReciter) {
            reciterSelect.value = savedReciter;
            populateMoshafs();
          }
        }
      }

      function populateMoshafs() {
        moshafSelect.disabled = true;
        moshafSelect.innerHTML = `<option value="">-- اختر الرواية --</option>`;
        const reciterOpt = reciterSelect.options[reciterSelect.selectedIndex];
        if (!reciterOpt || !reciterOpt.dataset.moshaf) return;
        try {
          const moshafArray = JSON.parse(reciterOpt.dataset.moshaf || '[]');
          moshafArray.forEach((m, index) => {
            moshafSelect.innerHTML += `<option value="${index}" data-server="${m.server}" data-surahs="${m.surah_list}">${m.name}</option>`;
          });
          moshafSelect.disabled = false;

          const savedMoshaf = localStorage.getItem('quran_moshaf');
          if (savedMoshaf && moshafSelect.options[savedMoshaf]) {
            moshafSelect.value = savedMoshaf;
            populateSurahs();
          }
        } catch {}
      }

      async function populateSurahs() {
        surahSelect.disabled = true;
        const data = await fetchJson(`https://www.mp3quran.net/api/v3/suwar?language=${languageSelect.value}`);
        if (data?.suwar) {
          surahsData = data.suwar;
          let availableSurahs = [];
          if (moshafSelect.value) {
            const allowedIds = new Set(moshafSelect.options[moshafSelect.selectedIndex].dataset.surahs.split(','));
            availableSurahs = surahsData.filter(s => allowedIds.has(String(s.id)));
          }
          surahSelect.innerHTML = `<option value="">-- اختر السورة --</option>` +
            availableSurahs.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
          surahSelect.disabled = false;

          const savedSurah = localStorage.getItem('quran_surah');
          if (savedSurah && availableSurahs.find(s => s.id == savedSurah)) {
            surahSelect.value = savedSurah;
            savedTime = parseFloat(localStorage.getItem('quran_time')) || 0;
            updatePlayer(true, savedTime);
          }
        }
      }

      function buildAudioUrl() {
        const surahId = surahSelect.value;
        const server = moshafSelect.options[moshafSelect.selectedIndex]?.dataset.server;
        if (server) {
          return `${server}${String(surahId).padStart(3, '0')}.mp3`;
        }
        return null;
      }

      function updatePlayer(autoplay = false, startTime = 0) {
        const audioUrl = buildAudioUrl();
        const surahName = surahsData.find(s => s.id == surahSelect.value)?.name || '';
        const reciterName = reciterSelect.options[reciterSelect.selectedIndex]?.text || '';

        if (!audioUrl) { playerWrapper.style.display = 'none'; return; }

        playerSurahName.textContent = surahName;
        playerReciterName.textContent = reciterName;
        downloadLink.href = audioUrl;
        downloadLink.download = `${reciterName}_${surahName}.mp3`;

        plyrPlayer.source = { type: 'audio', title: surahName, sources: [{ src: audioUrl, type: 'audio/mp3' }] };
        playerWrapper.style.display = 'block';

        plyrPlayer.once('loadedmetadata', () => {
          if (startTime > 0) plyrPlayer.currentTime = startTime;
          if (autoplay) plyrPlayer.play().catch(()=>{});
        });
      }

      async function forceDownload(url, filename) {
        if (isDownloading) return;
        isDownloading = true;
        showLoading('...جاري تجهيز التحميل');
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error();
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(blobUrl);
        } catch {
          alert('فشل التنزيل. حاول مرة أخرى.');
        } finally {
          isDownloading = false;
          hideLoading();
        }
      }

      // Save playback time
      plyrPlayer.on('timeupdate', () => {
        if (surahSelect.value) {
          localStorage.setItem('quran_time', plyrPlayer.currentTime);
        }
      });

      downloadLink.addEventListener('click', e => {
        e.preventDefault();
        const reciterName = reciterSelect.options[reciterSelect.selectedIndex]?.text || '';
        const surahName = surahsData.find(s => s.id == surahSelect.value)?.name || '';
        const url = downloadLink.href;
        if (url && url !== '#') {
          forceDownload(url, `${reciterName}_${surahName}.mp3`);
        }
      });

      languageSelect.addEventListener('change', async () => {
        localStorage.setItem('quran_language', languageSelect.value);
        plyrPlayer.stop();
        playerWrapper.style.display = 'none';
        await populateReciters();
      });

      reciterSelect.addEventListener('change', () => {
        localStorage.setItem('quran_reciter', reciterSelect.value);
        localStorage.removeItem('quran_surah');
        localStorage.removeItem('quran_time');
        plyrPlayer.stop();
        playerWrapper.style.display = 'none';
        populateMoshafs();
        surahSelect.innerHTML = `<option value="">-- اختر السورة --</option>`;
        surahSelect.disabled = true;
      });

      moshafSelect.addEventListener('change', () => {
        localStorage.setItem('quran_moshaf', moshafSelect.value);
        localStorage.removeItem('quran_surah');
        localStorage.removeItem('quran_time');
        plyrPlayer.stop();
        playerWrapper.style.display = 'none';
        populateSurahs();
      });

      surahSelect.addEventListener('change', () => {
        localStorage.setItem('quran_surah', surahSelect.value);
        localStorage.removeItem('quran_time');
        if (surahSelect.value) updatePlayer(true);
      });

      (async () => {
        await populateReciters();
      })();
    });
  </script>
</body>
</html>